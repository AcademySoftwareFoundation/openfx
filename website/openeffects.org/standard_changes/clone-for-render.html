<!DOCTYPE html>
<html>
<head>
<title> Standard Changes Clone For Render |  The Open Effects Association</title>
<link rel="shortcut icon" type="image/x-icon" href="/assets/ofx_favicon-c6cb586c0f8efbaeff3167d1fd7cfca2.ico" />
<link rel="stylesheet" media="all" href="/assets/application-8fbc3aa4b380a52e15d414a59177d3a2.css" />
<script src="/assets/application-f474998312dbf9d63cf3d555583ac5a1.js"></script>
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="Gu47+dYdazkNyeabmlZQ+9yOs8BXX38jp/kIU80TVTk09FNKcClmFrgWpHbuZOsvia7HhQ4iWcFp+Bw+2EJUAg==" />
<meta content='IE=edge' http_equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1' name='viewport'>
<script src='//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js'></script>
</head>
<body class='c_standard_changes a_show' data-spy='scroll' data-target='.navbar-top' role='document'>
<div class='modal fade' id='terminal'>
<div class='modal-dialog modal-lg'>
<div class='modal-content'>
<div class='modal-header'>
<div aria-hidden='true' class='button close' data-dismiss='modal' type='button'>&times;</div>
<h4 class='modal-title'>Terminal Output</h4>
</div>
<div class='modal-body'>
<div class='window'></div>
</div>
</div>
</div>
</div>
<div class='wrapper'>
<div class='navbar navbar-inverse navbar-fixed-top' role='components'>
<div class='container'>
<div class='navbar-header'>
<button class='navbar-toggle' data-target='.navbar-collapse' data-toggle='collapse' type='button'>
<span class='sr-only'>Toggle components</span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
</button>
</div>
<div class='navbar-collapse collapse'>
<div class='row'>
<div class='navbar-left'>
<div class='navbar-top'>
<div class='mobile'>
<ul class='nav navbar-nav'>
<li><a href="/">Welcome</a></li>
<li><a class="navbar-link" href="/standard_changes">Standards Discussion</a></li>
<li><a class="navbar-link" href="/contact_form">Contact</a></li>
</ul>
</div>
<div class='desktop'>
<ul class='nav navbar-nav'>
<li class='nav-logo'>
<a class="navbar-link" href="/"><img src="/assets/OFX_small-41bc647075217376f758003aebeacf15.png" alt="Ofx small" /></a>
</li>
<li class='dropdown'>
<a href="/">Welcome <span class="glyphicon glyphicon-circle-arrow-left"></span></a>
<ul class='dropdown-menu inverse-dropdown'>
<li>
<a class="navbar-link" href="#standard">Why a Standard?</a>
</li>
<li>
<a class="navbar-link" href="#implementers">For Implementers</a>
</li>
<li>
<a class="navbar-link" href="#organization">Association Business</a>
</li>
</ul>
</li>
<li class='dropdown api'>
<a class='navbar-link'>API Documentation <span class="glyphicon glyphicon-circle-arrow-down"></span></a>
<ul class='dropdown-menu inverse-dropdown'>
<li>
<a class="navbar-link" target="_blank" href="/documentation/api_doc">API Reference</a>
</li>
<li>
<a class="navbar-link" target="_blank" href="https://openfx.readthedocs.io/en/doc/Reference/index.html">Programming Reference</a>
</li>
<li>
<a class="navbar-link" target="_blank" href="https://openfx.readthedocs.io/en/doc/Guide/index.html">Programming Guide</a>
</li>
</ul>
</li>
<li><a class="navbar-link" href="/standard_changes">Standards Discussion</a></li>
<li><a class="navbar-link" href="/contact_form">Contact</a></li>
</ul>
</div>
</div>
</div>
<div class='desktop'>
<form role="form" class="navbar-form navbar-right form-inline" action="/users/sign_in" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="EeUzgXhtwz4NpyZz6bf0DMUXbIs8FmkGx9wqfmIAUm4//1sy3lnOEbh4ZJ6dhU/YkDcYzmVrT+QJ3T4Td1FTVQ==" />
<div class='form-group'>
<input type="text" name="user[email]" id="user_email" class="form-control input-xs" placeholder="Email" />
</div>
<div class='form-group'>
<input type="password" name="user[password]" id="user_password" class="form-control input-xs" placeholder="Password" />
</div>
<button class='btn btn-sm btn-primary' type='submit'>Sign in</button>
</form>

</div>
</div>
</div>
</div>
</div>
<div class='container' role='main'>
</div>
<div class='container'>
<div class='row'>
<div class='col-md-offset-2 col-md-8'>
<div class='btn-group'>
<a type="button" class="btn btn-default" href="/standard_changes"><span class='glyphicon glyphicon-circle-arrow-left'></span> Back to standard change list</a>
</div>

<br>
<br>
<div class='panel panel-warning'>
<div class='panel-heading'>
<h3 class='panel-title'>
Clone For Render
<span class='pull-right'>Proposed</span>
</h3>
</div>
<div class='panel-body'>
<p>
<b>Standard version:</b>
1.5
</p>
<p>
<b>Major Change</b>
</p>
<label>Subcommittee</label>
<p></p>
<label>Overview</label>
<p>(sept 23, 2016) - this is to be simultaneously addressed with caching and multi-processing.</p>
<p>Currently only one kind of plug-in instance is recognised, this is used for everything, interface, caching state, rendering etc&hellip; Many host applications have severe problems with this model, as they typically have separate render objects that are either lightweight special purpose render objects, or cloned on demand copies of the effect.</p>
<p>To deal with the current API, they either have multiple instances of a plug-in around, continually syncing data from the persistant/UI version to the render version, or they do this on demand. This often leads to sub-optimal performance and a great deal of complexity.</p>
<p>Plug-ins also find this difficult, as they often cache data in an instance, expecting to be able to re-use that data on the next render (eg: motion vectors from a retimer). In a clone on demand host, as the instance is continually being re-created, this cached data is always being destroyed once the temporary render instance is released.</p>
<p>A good way to manage this would be to have the API support a special purpose lightweight render instance object. The full effect instance is asked to populate one of these with any data it needs for the render action (and related actions such as RoD/RoI?), this object is then called to do the actual pixel pushing. This decouples object persistence and interface from processing, and allows for better multi threaded behaviour.</p>
<p>This is a major and complex change to the API and needs to be thoroughly discussed between host devs and plug-in devs.</p>
<p>As plug-ins are currently caching data between renders within the persistent instance (as in our retimer example), we still need to allow a plug-in to cache data in some manner. A better way all round would be for an explicit caching API, which a render object or persistent object could both commit and retrieve data to a host managed cache in a thread safe manner.</p>
<label>Solution</label>

</div>
</div>
<div class='btn-group'>
<a type="button" class="btn btn-default" href="/standard_changes"><span class='glyphicon glyphicon-circle-arrow-left'></span> Back to standard change list</a>
</div>

<br>
<br>
<div class='panel panel-default'>
<div class='panel-body'>
<h4 class='text-primary'>Discussion</h4>
<h5>Comments</h5>
<div class='well well-sm'>
<div class='comment user-43' id='cid-308'>
<div class='content'>
<p>In Natron 3 we clone all effects in the render tree for each&nbsp;<strong>time</strong> and <strong>view </strong>(as in the multiview extension)&nbsp;passed to the render action.</p>
<p>All actions that are typically called on a render threads are instead called on each of these clones.</p>
<p>&nbsp;</p>
<p>Each clone gets a set of cloned parameters where their value is&nbsp;cloned from the main instance parameters for the requested time and view. These means that we can guarantee that a value will not change between 2 actions called for a single same render.</p>
<p>In case of an animated parameter, if the plug-in calls getValue instead of getValueAtTime, we are able to recover the current time of the current action of the plug-in because each ImageEffect clone&nbsp;was created to render a specific time.</p>
<p>Cloning effects allows to partially&nbsp;resolve the "loss of context" of the host when&nbsp;calling suite functions. In our case, we found out that it almost completely removes the need to use thread local storage on the host side, except for the multi-thread suite and strings storage.</p>
<p>In order for this to work nicely, it is important that the render clone does not perform expensive operations in the create instance action: it should only fetch its parameters.&nbsp;</p>
<p>A possible way to do it would be to have an action similar to the create instance action, but that would be specific to create an ImageEffect render instance, where the plug-in is expected not to do more than fetching parameters.&nbsp;This action should also get a pointer to the main-thread instance so that the render instance can nicely cache data in a convenient way.</p>
<p>&nbsp;</p>
<p>Specification:</p>
<p>&nbsp;</p>
<p><code class="code">handle</code>&nbsp;handle to the plug-in instance, cast to an&nbsp;<code class="code">OfxImageEffectHandle</code></p>
<p><code class="code">inArgs</code>&nbsp;: Contains the following &nbsp;property:</p>
<p>/** &nbsp;@brief Pointer property x1 pointing to the main-thread OfxImageEffectHandle</p>
<p>*/</p>
<p>#define kOfxImageEffectMainInstanceHandle "OfxImageEffectMainInstanceHandle"&nbsp;</p>
<p>&nbsp;</p>
<div class="itemizedlist">
<ul class="itemizedlist">
<li class="listitem"><code class="code">outArgs</code>&nbsp;is redundant and is set to NULL.</li>
</ul>
</div>
<p>&nbsp;This action is similar to the&nbsp;kOfxActionCreateInstance action except that the ImageEffect is only to be used for render actions. This should be the first action called on a render thread so that the ImageEffect instance can&nbsp;have a consistent state throughout all actions of the render threads.</p>
<p>It is expected that this action only fetches its parameters.&nbsp;</p>
<p>The&nbsp;kOfxImageEffectMainInstanceHandle can be used to cache or retrieved cached data on the main-thread instance.</p>
<p>#define kOfxActionCreateRenderInstance "OfxActionCreateRenderInstance"</p>
<p>&nbsp;</p>
</div>
</div>
<div class='author text-muted'>
Alexandre | 12:06 pm,  19 Apr 2017
</div>
</div>

<div class='well well-sm'>
<div class='comment user-11' id='cid-275'>
<div class='content'>
<p>Just to add another example</p>
<p>(e.g. a new *OfxPropExtraInstanceData per frame rendered)&nbsp; - my example: If I have a 3D table of 8192 floating point per column I collected by pressing a button and fetching an image or a file and this won't change, I would like to maintain that on InstanceData and ExtraPerFrameInstanceData could just have a pointer to the pointer in my InstanceData, as opposed to copy it all, no big deal for me to wait for render queue ended signal if I need to write to this again - and yes this can be stored in custom param with synch private data in project file for project load and save.</p>
<p>&nbsp;</p>
</div>
</div>
<div class='author text-muted'>
Pierre Jasmin |  9:29 pm,  24 Sep 2016
</div>
</div>

<div class='well well-sm'>
<div class='comment user-43' id='cid-272'>
<div class='content'>
<p>After a discussion&nbsp;on our side we propose the following&nbsp;behaviour:&nbsp;</p>
<p>-&nbsp;<strong>getParameterValuesAction</strong>:&nbsp;Has in inArgs property set the same arguments than passed to a render action (time, view, render scale etc...)&nbsp;</p>
<p>In outArgs allocates a structure&nbsp;created on plug-in side with all parameter values fetched into it that are going to be needed in any call of&nbsp;render actions, i.e:</p>
<ul class="itemizedlist">
<li class="listitem"><a class="link" title="The Begin Sequence Render Action" href="http://openfx.sourceforge.net/Documentation/1.3/ofxProgrammingReference.html#kOfxImageEffectActionBeginSequenceRender"><code class="code">kOfxImageEffectActionBeginSequenceRender</code></a></li>
<li class="listitem"><a class="link" title="The Render Action" href="http://openfx.sourceforge.net/Documentation/1.3/ofxProgrammingReference.html#kOfxImageEffectActionRender"><code class="code">kOfxImageEffectActionRender</code></a></li>
<li class="listitem"><a class="link" title="The End Sequence Render Action" href="http://openfx.sourceforge.net/Documentation/1.3/ofxProgrammingReference.html#kOfxImageEffectActionEndSequenceRender"><code class="code">kOfxImageEffectActionEndSequenceRender</code></a></li>
<li class="listitem"><a class="link" title="The Is Identity Action" href="http://openfx.sourceforge.net/Documentation/1.3/ofxProgrammingReference.html#kOfxImageEffectActionIsIdentity"><code class="code">kOfxImageEffectActionIsIdentity</code></a></li>
<li class="listitem"><a class="link" title="The Get Frames Needed Action" href="http://openfx.sourceforge.net/Documentation/1.3/ofxProgrammingReference.html#kOfxImageEffectActionGetFramesNeeded"><code class="code">kOfxImageEffectActionGetFramesNeeded</code></a></li>
<li class="listitem"><code class="code"><a class="link" title="The Get Region of Definition Action" href="http://openfx.sourceforge.net/Documentation/1.3/ofxProgrammingReference.html#kOfxImageEffectActionGetRegionOfDefinition">kOfxImageEffectActionGetRegionOfDefinition</a></code></li>
<li class="listitem"><a class="link" title="The Get Regions Of Interest Action" href="http://openfx.sourceforge.net/Documentation/1.3/ofxProgrammingReference.html#kOfxImageEffectActionGetRegionsOfInterest">kOfxImageEffectActionGetRegionsOfInterest</a></li>
</ul>
<p>&nbsp;</p>
<p>The&nbsp;outArgs contain a kOfxImageEffectParamValuesHandle property of type pointer x1 which points to the struct returned by the plug-in.&nbsp;</p>
<p>If the pointer property is set the host must call the destroyParameterValuesAction to&nbsp;let a chance to the plug-in to clean-up the struct it allocated.</p>
<p>All the inArgs of the&nbsp;render actions aforementionned above get the new property&nbsp;kOfxImageEffectParamValuesHandle which can be null or not.&nbsp;</p>
<p>If non null the plug-in must make use of the values in the struct pointed to bykOfxImageEffectParamValuesHandle. Otherwise the plug-in can make use&nbsp;of regular calls to getValue/getValueAtTime on its parameters.</p>
<p>&nbsp;</p>
<p>-&nbsp;<strong>destroyParameterValuesAction</strong>: In inArgs the&nbsp;kOfxImageEffectParamValuesHandle pointer property pointed to a struct previously allocated by&nbsp;getParameterValuesAction. Any call to&nbsp;getParameterValuesAction must have a matching call to&nbsp;destroyParameterValuesAction.</p>
<p>Typically the host would call getParameterValuesAction before calling any other render action listed above and when done would call the corresponding&nbsp;destroyParameterValuesAction.</p>
<p>&nbsp;</p>
<p>This lets a chance to the plug-in to have a consistant state of values throughought the render of a frame for all&nbsp;actions used.</p>
<p>Without this extension the host has to come up with its own sort of cloning or locking of parameters which is a lot&nbsp;less efficient.&nbsp;</p>
<p>&nbsp;</p>
<p>Secondly, this extension can be coupled with the&nbsp;<a href="loss-of-host-calling-context-on-all-suite-calls">http://openeffects.org/standard_changes/loss-of-host-calling-context-on-all-suite-calls</a>&nbsp;nicely:</p>
<p>If all the getValue/getValueAtTime functions can have in inArgs an optional context pointer passed by the host,&nbsp;the host can then be aware of all the values fetched by a plug-in during the getParameterValuesAction. This can help&nbsp;the host in the purpose of caching.&nbsp;</p>
<p>&nbsp;</p>
<p>The only unresolved point by our proposition is to address the parametric parameters extension: the current description of the curve is in no way enough for the plug-in to know what&nbsp;kind of spline and interpolation is used on the host side. It makes impossible for&nbsp;a plug-in used parametric parameters to use the getParameterValuesAction.&nbsp;</p>
<p>We would have to come up with a ParametricSuiteV2 describing curves with intepolations methods used by the host in order to support them in this new action.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</div>
</div>
<div class='author text-muted'>
Alexandre |  8:17 am,  15 Sep 2016
</div>
</div>

<div class='well well-sm'>
<div class='comment user-0' id='cid-227'>
<div class='content'>
<ul>
<li>
                  Phil Barret : Baselight generally renders in a different process, and very often on different hosts, so cloning render objects won't help me. But an
                  <abbr title="Application Programming Interface">API</abbr>
                  to reduce the amount of data streaming (e.g. declaring that some/all params will only be read at the render time, so I don't need to stream the animation) would be welcome.
               </li>
<li> Bruno Nicoletti : In Nuke, we definitely need light weight clones of the main instance, which are created/set single threaded, but get to render image data multi threaded. The setting is basically a whole load of getParameterAtTime calls pumping values into local variables. Your host could track what the lightweight clone requests on the main host and only send that data over to each of the nodes in the cluster for each of their clones. A bit of messing around, but it should work. Otherwise a serialisation of the render objects would be needed to satisfy us both.</li>
<li>
                  Pierre Jasmin : If the need is to create a render instance that does not carry around the whole animation system in case + the equivalent of PF_PreRenderExtra in AE
                  <abbr title="Application Programming Interface">API</abbr>
                  (DOD,ROI) Looking at our base class, the non-trivial part is parameters. One idea would be to add an additional state to a parameter at creation in param suite V2 :
                  <ul>
<li> 0. : I will only read  this param at current time</li>
<li> N:  always read a time window of N frames from current time (and at integer times?)</li>
<li> -1:  randomly request  param values at any time (then you would need to strore the whole parameter over time in your instance)</li>
</ul>
               </li>
<li> Not as efficient but this would get you there most of the time and then paramGetValue(AtTime) would not need to changed in render calls, and another action would not be needed just to store parameters per frame.</li>
</ul>
</div>
</div>
<div class='author text-muted'>
unattributed |  9:49 am,   8 Mar 2014
</div>
</div>

</div>
</div>

<div class='btn-group'>
<a type="button" class="btn btn-default" href="/standard_changes"><span class='glyphicon glyphicon-circle-arrow-left'></span> Back to standard change list</a>
</div>

</div>
</div>
</div>

<div class='push'></div>
</div>
<footer>
<ul class='footer-link-group'>
<li>
<a target="_blank" class="footer-link" href="https://github.com/ofxa/openfx">OFX @ Github</a>
</li>
<li>
<a title="Association details" class="footer-link" href="/contents/page/association_information">Association Information</a>
</li>
</ul>
<br>
Copyright  &copy;2023 The Open Effects Association
</footer>
</body>
</html>
