<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
      <title>Chapter 6. Thread and Recursion Safety</title>
      <link rel="stylesheet" type="text/css" href="/assets/ofxStyle.css"></link>
      <meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></meta>
      <link rel="home" href="/documentation/reference/index.html" title="The OFX Image Effect Plug-in API, 1.4, Programming Reference."></link>
      <link rel="up" href="/documentation/reference/index.html" title="The OFX Image Effect Plug-in API, 1.4, Programming Reference."></link>
      <link rel="prev" href="/documentation/reference/ch05s07.html" title="Parameters Mandated In A Context"></link>
      <link rel="next" href="/documentation/reference/ch07.html" title="Chapter 7. Coordinate Systems"></link>
      <link rel="stylesheet" type="text/css" href="/assets/ofx-docbook-nav.css"></link>
   </head>
   <body>
      <div id="ofx-main-nav">
         <ul>
            <li>
               <a href="/">
                  <img alt="Ofx small" src="/assets/OFX_small.png"></img>
               </a>
            </li>
            <li>
               <a href="/">
                  Back to Main Site
                  <span class="glyph"></span>
               </a>
            </li>
            <li>
               <a href="/documentation/api_doc">API Reference</a>
            </li>
            <li>
               <a href="/documentation/reference">Programming Reference</a>
            </li>
            <li>
               <a href="https://github.com/ofxa/openfx/blob/master/Guide/Doc/ofxProgrammingGuide.adoc">Programming Guide</a>
            </li>
         </ul>
      </div>
      <div class="wrapper" id="reference">
         <div class="navheader">
            <table width="100%" summary="Navigation header">
               <tr>
                  <th colspan="3" align="center">Chapter 6. Thread and Recursion Safety</th>
               </tr>
               <tr>
                  <td width="20%" align="left">
                     <a accesskey="p" href="/documentation/reference/ch05s07.html">Prev</a>
                      
                  </td>
                  <th width="60%" align="center"> </th>
                  <td width="20%" align="right">
                      
                     <a accesskey="n" href="/documentation/reference/ch07.html">Next</a>
                  </td>
               </tr>
            </table>
            <hr></hr>
         </div>
         <div class="chapter">
            <div class="titlepage">
               <div>
                  <div>
                     <h1 class="title">
                        <a id="idp11611984"></a>
                        Chapter 6. Thread and Recursion Safety
                     </h1>
                  </div>
               </div>
            </div>
            <p>
      Hosts are generally multi-threaded, those with a GUI will most likely have an interactive 
      thread and a rendering thread, while any host running on a multi-CPU machine may have a render 
      thread per CPU. Host may batch effects off to a render farm, where the same effect has separate
      frames rendered on completely different machines. OFX needs to address all these situations.
    </p>
            <p>
      Threads in the host application can be broken into two categories...
      </p>
            <div class="itemizedlist">
               <ul class="itemizedlist" style="list-style-type: disc; ">
                  <li class="listitem">
                     <span class="emphasis">
                        <em>main theaads</em>
                     </span>
                     , where any action may be called
                  </li>
                  <li class="listitem">
                     <span class="emphasis">
                        <em>render threads</em>
                     </span>
                     where only a subset of actions may be called.
                  </li>
               </ul>
            </div>
            <p>
    </p>
            <p>
               For a given effect instance, there can be only one main thread and zero or more render threads. An instance must be able to handle simultaneous actions called on the main and render threads. A plugin can control the number of simultaneous render threads via the
               <a class="link" href="/documentation/reference/re115.html" title="kOfxImageEffectPluginRenderThreadSafety">
                  <code class="code">kOfxImageEffectPluginRenderThreadSafety</code>
               </a>
               effect descriptor property.
            </p>
            <p>
      The only actions that can be called on a render thread are...
      </p>
            <div class="itemizedlist">
               <ul class="itemizedlist" style="list-style-type: disc; ">
                  <li class="listitem">
                     <a class="link" href="/documentation/reference/ch13s18.html" title="The Begin Sequence Render Action">
                        <code class="code">kOfxImageEffectActionBeginSequenceRender</code>
                     </a>
                  </li>
                  <li class="listitem">
                     <a class="link" href="/documentation/reference/ch13s17.html" title="The Render Action">
                        <code class="code">kOfxImageEffectActionRender</code>
                     </a>
                  </li>
                  <li class="listitem">
                     <a class="link" href="/documentation/reference/ch13s19.html" title="The End Sequence Render Action">
                        <code class="code">kOfxImageEffectActionEndSequenceRender</code>
                     </a>
                  </li>
                  <li class="listitem">
                     <a class="link" href="/documentation/reference/ch13s16.html" title="The Is Identity Action">
                        <code class="code">kOfxImageEffectActionIsIdentity</code>
                     </a>
                  </li>
                  <li class="listitem">
                     <a class="link" href="/documentation/reference/ch13s15.html" title="The Get Frames Needed Action">
                        <code class="code">kOfxImageEffectActionGetFramesNeeded</code>
                     </a>
                  </li>
                  <li class="listitem">
                     <a class="link" href="/documentation/reference/ch13s13.html" title="The Get Region of Definition Action">
                        <code class="code">kOfxImageEffectActionGetRegionOfDefinition</code>
                     </a>
                  </li>
                  <li class="listitem">
                     <a class="link" href="/documentation/reference/ch13s14.html" title="The Get Regions Of Interest Action">
                        <code class="code">kOfxImageEffectActionGetRegionsOfInterest</code>
                     </a>
                  </li>
               </ul>
            </div>
            <p>
    </p>
            <p>
      If a plugin cannot support this multi-threading behaviour, it will need to perform explicit locking itself,
      using the locking mechanisms in the suites defined in ofxMultiThread.h
    </p>
            <p>
      This will also mean that the host may need to perform locking on the various function calls over the API.
      For example, a main and render thread may both simultaneously attempt to access a parameter from a single effect
      instance. The locking should...
      </p>
            <div class="itemizedlist">
               <ul class="itemizedlist" style="list-style-type: disc; ">
                  <li class="listitem">block write/read access</li>
                  <li class="listitem">not block on read/read access</li>
                  <li class="listitem">be fine grained at the level of individual function calls,</li>
                  <li class="listitem">be transparent to the plugin, so it will block until the call succeeds.</li>
               </ul>
            </div>
            <p>
    </p>
            <p>
      For example, a render thread will only cause a parameter to lock out writes only for the duration of 
      the call that reads the parameter, not for the duration of the whole render action. This will allow a
      main thread to continue writing to the parameter during a render. This is especially important if you
      have a custom interactive GUI that you want to keep working during a render call.
    </p>
            <p>
      Note that a main thread should generally issue an abort to any linked render thread when a
      parameter or other value affecting the effect (eg: time) has been changed by the user. A re-render
      should then be issued so that a correct frame is created.
    </p>
            <p>
      How an effect handles simulanteous calls to render is dealt with in \ref ImageEffectsMultiThreadingRendering.
    </p>
            <p>
      Many hosts get around the problem of sharing a single instance in a UI thread and a render thread by
      having two instances, one for the user to interact with and a render only one that shadows the
      UI instance. 
    </p>
            <div class="section">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both">
                           <a id="idp11629696"></a>
                           Recursive Actions
                        </h2>
                     </div>
                  </div>
               </div>
               <p>
	When running on a main thread, some actions may end up being called recursively. A plug-in 
	must be able to deal with this.
	For example consider the following sequence of events in a plugin...
	</p>
               <div class="orderedlist">
                  <ol class="orderedlist" type="1">
                     <li class="listitem">user sets parameter A in a GUI</li>
                     <li class="listitem">
                        host issues
                        <a class="link" href="/documentation/reference/ch13s07.html" title="The Generic Instance Changed Action">
                           <code class="code">kOfxActionInstanceChanged</code>
                        </a>
                        action
                     </li>
                     <li class="listitem">
                        plugin traps that and sets parameter B
                        <div class="orderedlist">
                           <ol class="orderedlist" type="a">
                              <li class="listitem">
                                 host issues a new
                                 <a class="link" href="/documentation/reference/ch13s07.html" title="The Generic Instance Changed Action">
                                    <code class="code">kOfxActionInstanceChanged</code>
                                 </a>
                                 action for parameter B
                              </li>
                              <li class="listitem">
                                 plugin traps that and changes some internal private state and requests the overlay redraw itself
                                 <div class="orderedlist">
                                    <ol class="orderedlist" type="i">
                                       <li class="listitem">
                                          <a class="link" href="/documentation/reference/ch14s04.html" title="The Draw Action">
                                             <code class="code">kOfxInteractActionDraw</code>
                                          </a>
                                          issued to the effect's overlay
                                       </li>
                                       <li class="listitem">plugin draws overlay</li>
                                       <li class="listitem">
                                          <a class="link" href="/documentation/reference/ch14s04.html" title="The Draw Action">
                                             <code class="code">kOfxInteractActionDraw</code>
                                          </a>
                                          returns
                                       </li>
                                    </ol>
                                 </div>
                              </li>
                              <li class="listitem">
                                 <a class="link" href="/documentation/reference/ch13s07.html" title="The Generic Instance Changed Action">
                                    <code class="code">kOfxActionInstanceChanged</code>
                                 </a>
                                 action for parameter B returns
                              </li>
                           </ol>
                        </div>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch13s07.html" title="The Generic Instance Changed Action">
                           <code class="code">kOfxActionInstanceChanged</code>
                        </a>
                        action returns
                     </li>
                  </ol>
               </div>
               <p>
      </p>
               <p>
	The image effect actions which may trigger a recursive action call on a single instance are...
	</p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: disc; ">
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch13s06.html" title="The Generic Begin/End Instance Changed Actions">
                           <code class="code">kOfxActionBeginInstanceChanged</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch13s07.html" title="The Generic Instance Changed Action">
                           <code class="code">kOfxActionInstanceChanged</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="ch13s06.html#kOfxActionEndInstanceChanged">
                           <code class="code">kOfxActionEndInstanceChanged</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch13s09.html" title="The Sync Private Data Action">
                           <code class="code">kOfxActionSyncPrivateData</code>
                        </a>
                     </li>
                  </ul>
               </div>
               <p>
      </p>
               <p>
	The interact actions which may trigger a recursive action to be called on the associated plugin instance are...
	</p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: disc; ">
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch14s11.html" title="kOfxInteractActionGainFocus">
                           <code class="code">kOfxInteractActionGainFocus</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch14s08.html" title="kOfxInteractActionKeyDown">
                           <code class="code">kOfxInteractActionKeyDown</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch14s10.html" title="kOfxInteractActionKeyRepeat">
                           <code class="code">kOfxInteractActionKeyRepeat</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch14s09.html" title="kOfxInteractActionKeyUp">
                           <code class="code">kOfxInteractActionKeyUp</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch14s12.html" title="kOfxInteractActionLoseFocus">
                           <code class="code">kOfxInteractActionLoseFocus</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch14s06.html" title="kOfxInteractActionPenDown">
                           <code class="code">kOfxInteractActionPenDown</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch14s05.html" title="kOfxInteractActionPenMotion">
                           <code class="code">kOfxInteractActionPenMotion</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch14s07.html" title="kOfxInteractActionPenUp">
                           <code class="code">kOfxInteractActionPenUp</code>
                        </a>
                     </li>
                  </ul>
               </div>
               <p>
      </p>
               <p>
	The image effect actions which may be called recursively are...
	</p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: disc; ">
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch13s06.html" title="The Generic Begin/End Instance Changed Actions">
                           <code class="code">kOfxActionBeginInstanceChanged</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch13s07.html" title="The Generic Instance Changed Action">
                           <code class="code">kOfxActionInstanceChanged</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="ch13s06.html#kOfxActionEndInstanceChanged">
                           <code class="code">kOfxActionEndInstanceChanged</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch13s20.html" title="The Get Clip Preferences Action">
                           <code class="code">kOfxImageEffectActionGetClipPreferences</code>
                        </a>
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch13s13.html" title="The Get Region of Definition Action">
                           <code class="code">kOfxImageEffectActionGetRegionOfDefinition</code>
                        </a>
                        (as a result of calling
                        <a class="link" href="/documentation/reference/re27.html" title="OfxImageEffectSuiteV1::clipGetImage">
                           <code class="code">OfxImageEffectSuiteV1::clipGetImage</code>
                        </a>
                        from
                        <a class="link" href="/documentation/reference/ch13s07.html" title="The Generic Instance Changed Action">
                           <code class="code">kOfxActionInstanceChanged</code>
                        </a>
                        )
                     </li>
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch13s14.html" title="The Get Regions Of Interest Action">
                           <code class="code">kOfxImageEffectActionGetRegionsOfInterest</code>
                        </a>
                        (as a result of calling
                        <a class="link" href="/documentation/reference/re27.html" title="OfxImageEffectSuiteV1::clipGetImage">
                           <code class="code">OfxImageEffectSuiteV1::clipGetImage</code>
                        </a>
                        from
                        <a class="link" href="/documentation/reference/ch13s07.html" title="The Generic Instance Changed Action">
                           <code class="code">kOfxActionInstanceChanged</code>
                        </a>
                        )
                     </li>
                  </ul>
               </div>
               <p>
      </p>
               <p>
	The interact actions which may be called recursively are...
	</p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: disc; ">
                     <li class="listitem">
                        <a class="link" href="/documentation/reference/ch14s04.html" title="The Draw Action">
                           <code class="code">kOfxInteractActionDraw</code>
                        </a>
                     </li>
                  </ul>
               </div>
               <p>
      </p>
            </div>
         </div>
         <div class="navfooter">
            <hr></hr>
            <table width="100%" summary="Navigation footer">
               <tr>
                  <td width="40%" align="left">
                     <a accesskey="p" href="/documentation/reference/ch05s07.html">Prev</a>
                      
                  </td>
                  <td width="20%" align="center"> </td>
                  <td width="40%" align="right">
                      
                     <a accesskey="n" href="/documentation/reference/ch07.html">Next</a>
                  </td>
               </tr>
               <tr>
                  <td width="40%" align="left" valign="top">Parameters Mandated In A Context </td>
                  <td width="20%" align="center">
                     <a accesskey="h" href="/documentation/reference/index.html">Home</a>
                  </td>
                  <td width="40%" align="right" valign="top"> Chapter 7. Coordinate Systems</td>
               </tr>
            </table>
         </div>
      </div>
   </body>
</html>
