<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
      <title>Chapter 7. Coordinate Systems</title>
      <link rel="stylesheet" type="text/css" href="/assets/ofxStyle.css"></link>
      <meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></meta>
      <link rel="home" href="/documentation/reference/index.html" title="The OFX Image Effect Plug-in API, 1.4, Programming Reference."></link>
      <link rel="up" href="/documentation/reference/index.html" title="The OFX Image Effect Plug-in API, 1.4, Programming Reference."></link>
      <link rel="prev" href="/documentation/reference/ch06.html" title="Chapter 6. Thread and Recursion Safety"></link>
      <link rel="next" href="/documentation/reference/ch07s02.html" title="Temporal Coordinates"></link>
      <link rel="stylesheet" type="text/css" href="/assets/ofx-docbook-nav.css"></link>
   </head>
   <body>
      <div id="ofx-main-nav">
         <ul>
            <li>
               <a href="/">
                  <img alt="Ofx small" src="/assets/OFX_small.png"></img>
               </a>
            </li>
            <li>
               <a href="/">
                  Back to Main Site
                  <span class="glyph"></span>
               </a>
            </li>
            <li>
               <a href="/documentation/api_doc">API Reference</a>
            </li>
            <li>
               <a href="/documentation/reference">Programming Reference</a>
            </li>
            <li>
               <a href="https://github.com/ofxa/openfx/blob/master/Guide/Doc/ofxProgrammingGuide.adoc">Programming Guide</a>
            </li>
         </ul>
      </div>
      <div class="wrapper" id="reference">
         <div class="navheader">
            <table width="100%" summary="Navigation header">
               <tr>
                  <th colspan="3" align="center">Chapter 7. Coordinate Systems</th>
               </tr>
               <tr>
                  <td width="20%" align="left">
                     <a accesskey="p" href="/documentation/reference/ch06.html">Prev</a>
                      
                  </td>
                  <th width="60%" align="center"> </th>
                  <td width="20%" align="right">
                      
                     <a accesskey="n" href="/documentation/reference/ch07s02.html">Next</a>
                  </td>
               </tr>
            </table>
            <hr></hr>
         </div>
         <div class="chapter">
            <div class="titlepage">
               <div>
                  <div>
                     <h1 class="title">
                        <a id="CoordinateSystems"></a>
                        Chapter 7. Coordinate Systems
                     </h1>
                  </div>
               </div>
            </div>
            <div class="section">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both">
                           <a id="idp11665536"></a>
                           Spatial Coordinates
                        </h2>
                     </div>
                  </div>
               </div>
               <p>
	All OFX spatial coordinate systems have the positive Y axis pointing up, and the positive X axis pointing right.
      </p>
               <p>
                  As stated above, images are simply some rectangle in a potentially infinite plane of pixels. However, this is an idealisation of what really goes on, as images composed of real pixels have to take into account pixel aspect ratios and proxy render scales, as such they will
                  <span class="emphasis">
                     <em>not</em>
                  </span>
                  be in the same space as the image plane. To deal with this, OFX has three spatial coordinate systems
               </p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: disc; ">
                     <li class="listitem">
                        <span class="emphasis">
                           <em>The Canonical Coordinate System</em>
                        </span>
                        which describes the idealised image plane
                     </li>
                     <li class="listitem">
                        <span class="emphasis">
                           <em>The Pixel Coordinate System</em>
                        </span>
                        which describes coordinates in addressable pixels
                     </li>
                     <li class="listitem">
                        <span class="emphasis">
                           <em>The Normalised Canonical Coordinate System</em>
                        </span>
                        which allows for resolution independant description of parameters
                     </li>
                  </ul>
               </div>
               <p>
      </p>
               <div class="section">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title">
                              <a id="CanonicalCoordinates"></a>
                              Canonical Coordinates
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>
                     The idealised image plane is always in a coordinate system of square unscaled pixels. For example a PAL D1 frame occupies (0,0) to (768,576). We call this the
                     <span class="emphasis">
                        <em>Canonical Coordinate System</em>
                     </span>
                     .
                  </p>
                  <p>
	  Many operations take place in canonical coordinates, parameter values are expressed in them while the and RoD and RoI actions
	  report their values back in them.
	</p>
                  <p>
                     The Canonical coordinate system is always referenced by double floating point values, generally via a
                     <code class="code">OfxRectD</code>
                     structure.
                  </p>
               </div>
               <div class="section">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title">
                              <a id="PixelCoordinates"></a>
                              Pixel Coordinates
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>
                     'Real' images, where we have to deal with addressable pixels in memory, are in a coordinate system of non-square proxy scaled integer values. So a PAL D1 image, being renderred as a half resolution proxy would be (0,0) to (360, 288), which takes into account both the pixel aspect ratio of 1.067 and a scale factor of 0.5f. We call this the
                     <span class="emphasis">
                        <em>Pixel Coordinate System</em>
                     </span>
                     .
                  </p>
                  <p>
	  The Pixel coordinate system is always referenced by integer values, generally via a OfxRectI structure.
	  It is used when refering to operations on actual pixels, and so is how the bounds of images are described
	  and the render window passed to the render action.
	</p>
               </div>
               <div class="section">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title">
                              <a id="MappingCoordinates"></a>
                              Mapping Between The Spatial Coordinate Systems
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>
	  To map between the two the pixel aspect ratio and the render scale need to be known, and it is a simple case of multiplication and rounding. More specifically,  given...
	  </p>
                  <div class="itemizedlist">
                     <ul class="itemizedlist" style="list-style-type: disc; ">
                        <li class="listitem">
                           pixel aspect ratio,
                           <span class="emphasis">
                              <em>PAR</em>
                           </span>
                           , found on the image property
                           <a class="link" href="/documentation/reference/re157.html" title="kOfxImagePropPixelAspectRatio">
                              <code class="code">kOfxImagePropPixelAspectRatio</code>
                           </a>
                        </li>
                        <li class="listitem">
                           render scale in X
                           <span class="emphasis">
                              <em>SX</em>
                           </span>
                           , found on the first dimension of the effect property
                           <a class="link" href="/documentation/reference/re138.html" title="kOfxImageEffectPropRenderScale">
                              <code class="code">kOfxImageEffectPropRenderScale</code>
                           </a>
                        </li>
                        <li class="listitem">
                           render scale in Y
                           <span class="emphasis">
                              <em>SY</em>
                           </span>
                           , found on the second dimension of the effect property
                           <a class="link" href="/documentation/reference/re138.html" title="kOfxImageEffectPropRenderScale">
                              <code class="code">kOfxImageEffectPropRenderScale</code>
                           </a>
                        </li>
                        <li class="listitem">
                           field scale in Y
                           <span class="emphasis">
                              <em>FS</em>
                           </span>
                           , this is
                           <div class="itemizedlist">
                              <ul class="itemizedlist" style="list-style-type: circle; ">
                                 <li class="listitem">
                                    0.5 if the image property
                                    <a class="link" href="/documentation/reference/re156.html" title="kOfxImagePropField">
                                       <code class="code">kOfxImagePropField</code>
                                    </a>
                                    is
                                    <code class="code">kOfxImageFieldLower</code>
                                    or
                                    <code class="code">kOfxImageFieldUpper</code>
                                 </li>
                                 <li class="listitem">1.0 otherwise.</li>
                              </ul>
                           </div>
                        </li>
                     </ul>
                  </div>
                  <p>
	</p>
                  <p>
	To map an X and Y coordinates from Pixel coordinates to Canonical coordinates, we perform the following multiplications...
	</p>
                  <div class="blockquote">
                     <blockquote class="blockquote">
                        <pre class="programlisting">
  X' = (X * PAR)/SX
  Y' = Y/(SY * FS)
	</pre>
                     </blockquote>
                  </div>
                  <p>
	To map an X and Y coordinates from Canonical coordinates to Pixel coordinates, we perform the following multiplications...
	</p>
                  <div class="blockquote">
                     <blockquote class="blockquote">
                        <pre class="programlisting">
	  X' = (X * SX)/PAR
	  Y' = Y * SY * FS
	</pre>
                     </blockquote>
                  </div>
               </div>
               <div class="section">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title">
                              <a id="NormalisedCoordinateSystem"></a>
                              The Normalized Coordinate System
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>
                     Note, normalised parameters and the normalised coordinate system are being deprecated in favour of
                     <a class="link" href="ch09s09.html#ParameterPropertiesDoubleTypesSpatial" title="Spatial Parameters">spatial parameters</a>
                     which can handle the project rescaling without the problems of converting to/from normalised coordinates.
                  </p>
                  <p>
	  On most editing an compositing systems projects can be moved on resolutions, for example a
	  project may be set up at high definition then have several versions rendered out at different sizes, say a
	  PAL SD version, an NTSC SD version and an HD 720p version.
	</p>
                  <p>
	  This causes problems with parameters that describe spatial coordinates. If they are expressed as absolute 
	  positions, the values will be incorrect as the project is moved from resolution to resolution.
	  For example, a circle drawn at (384,288) in PAL SD canonical coordinates will be in the centre of the 
	  output. Re-render that at 2K film, it will be in  the bottom left hand corner, which is probably not the correct
	  spot.
	</p>
                  <p>
                     To get around this, OFX allows parameters to be flagged as
                     <span class="emphasis">
                        <em>normalised</em>
                     </span>
                     , which is a resolution independant method of representing spatial coordinates. In this coordinate system, a point expressed as (0.5, 0.5) will appear in the centre of the screen, always.
                  </p>
                  <p>
	  To transform between normalised and canonical coordinates a simple linear equation is required. What that is
	  requires a certain degree of explanation. It involves three two dimensional values...
	  </p>
                  <div class="itemizedlist">
                     <ul class="itemizedlist" style="list-style-type: disc; ">
                        <li class="listitem">
                           <span class="emphasis">
                              <em>the project extent</em>
                           </span>
                           the resolution of the project, eg: PAL SD
                        </li>
                        <li class="listitem">
                           <span class="emphasis">
                              <em>the project size</em>
                           </span>
                           how much of that is used by imagery, eg: the letter box area in a 16:9 PAL SD project
                        </li>
                        <li class="listitem">
                           <span class="emphasis">
                              <em>the project offset</em>
                           </span>
                           the bottom left corner of the extent being used, eg: the BL corner of a 16:9 PAL SD project
                        </li>
                     </ul>
                  </div>
                  <p>
	</p>
                  <p>
	  As described above, the project extent is the section of the image plane that is coverred
	  by an image that is the desired output of the project, so for a PAL SD project you get an extent of 0,0 to 768,576. 
	  As the project is always rooted at the origin, so the extent is actually a size.
	</p>
                  <p>
	  Project sizes and offsets are a bit less obvious. Consider a project that is going to be output as PAL D1 imagery,
	  the extent will be 0,0 to 768,576. However our example is a letter box 16:9 project, which leaves a strip of black at
	  bottom and top. The size of the letter box is 768 by 432, while the bottom left of the letter box is offset from the
	  origin by 0,77. The ASCII art below shows the details.....
	</p>
                  <div class="blockquote">
                     <blockquote class="blockquote">
                        <pre class="programlisting">
                                                (768,576) 
             ---------------------------------------
             |                                     |
             |                BLACK                |
             |.....................................| (768, 504)
             |                                     |
             |                                     |
             |        LETTER BOXED IMAGERY         |
             |                                     |
             |                                     |
      (0,72) |.....................................|
             |                                     |
             |                BLACK                |
             |                                     |
             ---------------------------------------
	   (0,0)
	</pre>
                     </blockquote>
                  </div>
                  <p>
	  So in this example...
	  </p>
                  <div class="itemizedlist">
                     <ul class="itemizedlist" style="list-style-type: disc; ">
                        <li class="listitem">
                           the
                           <span class="emphasis">
                              <em>extent</em>
                           </span>
                           of the project is the full size of the output image, which is 768x576,
                        </li>
                        <li class="listitem">
                           the
                           <span class="emphasis">
                              <em>size</em>
                           </span>
                           of the project is the size of the letter box section, which is 768x432,
                        </li>
                        <li class="listitem">
                           the
                           <span class="emphasis">
                              <em>offset</em>
                           </span>
                           of the project is the bottom left corner of the project window, which is 0,72.
                        </li>
                     </ul>
                  </div>
                  <p>
	</p>
                  <p>
	  The properties on an effect instance handle allow you to fetch these values...
	  </p>
                  <div class="itemizedlist">
                     <ul class="itemizedlist" style="list-style-type: disc; ">
                        <li class="listitem">
                           <a class="link" href="/documentation/reference/re131.html" title="kOfxImageEffectPropProjectExtent">
                              <code class="code">kOfxImageEffectPropProjectExtent</code>
                           </a>
                           for the extent of the current project,
                        </li>
                        <li class="listitem">
                           <a class="link" href="/documentation/reference/re134.html" title="kOfxImageEffectPropProjectSize">
                              <code class="code">kOfxImageEffectPropProjectSize</code>
                           </a>
                           for the size of the current project,
                        </li>
                        <li class="listitem">
                           <a class="link" href="/documentation/reference/re132.html" title="kOfxImageEffectPropProjectOffset">
                              <code class="code">kOfxImageEffectPropProjectOffset</code>
                           </a>
                           for the offset of the current project.
                        </li>
                     </ul>
                  </div>
                  <p>
	</p>
                  <p>
	  So to map from normalised coordinates to canonical coordinates, you use the project size and offset...
	  </p>
                  <div class="itemizedlist">
                     <ul class="itemizedlist" style="list-style-type: disc; ">
                        <li class="listitem">for values that represent a size simply multiply the normalised coordinate by the project size</li>
                        <li class="listitem">for values that represent an absolute position, multiply the normalised coordinate by the project size then add the project origin</li>
                     </ul>
                  </div>
                  <p>
	</p>
                  <p>
                     To flag to the host that a parameter as normalised, we use the
                     <a class="link" href="/documentation/reference/re193.html" title="kOfxParamPropDoubleType">
                        <code class="code">kOfxParamPropDoubleType</code>
                     </a>
                     property. Parameters that are so flagged have values set and retrieved by an effect in normalized coordinates. However a host can choose to represent them to the user in whatever space it chooses. The values that this property can take are...
                  </p>
                  <div class="itemizedlist">
                     <ul class="itemizedlist" style="list-style-type: disc; ">
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeX</code>
                           - a size in the X dimension dimension (1D only), new for 1.2
                        </li>
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeXAbsolute</code>
                           - a position in the X dimension (1D only), new for 1.2
                        </li>
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeY</code>
                           - a size in the Y dimension dimension (1D only), new for 1.2
                        </li>
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeYAbsolute</code>
                           - a position in the X dimension (1D only), new for 1.2
                        </li>
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeXY</code>
                           - a size in the X and Y dimension (2D only), new for 1.2
                        </li>
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeXYAbsolute</code>
                           - a position in the X and Y dimension (2D only), new for 1.2
                        </li>
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeNormalisedX</code>
                           - normalised size with respect to the project's X dimension (1D only), deprecated for 1.2
                        </li>
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeNormalisedXAbsolute</code>
                           - normalised absolute position on the X axis (1D only), deprecated for 1.2
                        </li>
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeNormalisedY</code>
                           - normalised size wrt to the project's Y dimension (1D only), deprecated for 1.2
                        </li>
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeNormalisedYAbsolute</code>
                           - normalised absolute position on the Y axis (1D only), deprecated for 1.2
                        </li>
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeNormalisedXY</code>
                           - normalised to the project's X and Y size (2D only), deprecated for 1.2
                        </li>
                        <li class="listitem">
                           <code class="code">kOfxParamDoubleTypeNormalisedXYAbsolute</code>
                           - normalised to the projects X and Y size, and is an absolute position on the image plane, deprecated for 1.2.
                        </li>
                     </ul>
                  </div>
                  <p>
	</p>
                  <p>
                     For example, we have an effect that draws a circle. It has two parameters a 1D double radius parametere and a 2D double position parameter. It would flag the radius to be
                     <code class="code">kOfxParamDoubleTypeNormalisedX</code>
                     , fetch the value and scale that by the project size before we render the circle. The host should present such normalised parameters to the user in a 'sensible' range. So for a PAL project, it would be from 0..768, where the plug-in sees 0..1.
                  </p>
                  <p>
                     The position can be handled by the
                     <code class="code">kOfxParamDoubleTypeNormalisedXYAbsolute</code>
                     case. In which case the plugin must scale the parameter's value by the project size and add in the project offset. This will allow the positional parameter to be moved between projects transparently.
                  </p>
               </div>
            </div>
         </div>
         <div class="navfooter">
            <hr></hr>
            <table width="100%" summary="Navigation footer">
               <tr>
                  <td width="40%" align="left">
                     <a accesskey="p" href="/documentation/reference/ch06.html">Prev</a>
                      
                  </td>
                  <td width="20%" align="center"> </td>
                  <td width="40%" align="right">
                      
                     <a accesskey="n" href="/documentation/reference/ch07s02.html">Next</a>
                  </td>
               </tr>
               <tr>
                  <td width="40%" align="left" valign="top">Chapter 6. Thread and Recursion Safety </td>
                  <td width="20%" align="center">
                     <a accesskey="h" href="/documentation/reference/index.html">Home</a>
                  </td>
                  <td width="40%" align="right" valign="top"> Temporal Coordinates</td>
               </tr>
            </table>
         </div>
      </div>
   </body>
</html>
